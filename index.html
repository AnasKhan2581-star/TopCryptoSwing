<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT/SMC 2022 Model Scanner</title>

    <style>
        :root {
            --bg-main: #09090b;
            --bg-card: #131316;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --border: #27272a;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Consolas', monospace;
            margin: 0;
            padding: 10px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* ---------- GRID LAYOUT (Updated for responsiveness) ---------- */
        .app-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr;
            gap: 12px;
            height: calc(100vh - 20px);
        }

        @media (max-width: 900px) {
            .app-grid {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                height: auto;
            }
        }

        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
            padding-top: 5px;
        }

        @media (max-width: 600px) {
            header { 
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
        }

        .tag {
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        @media (max-width: 600px) {
            .controls {
                width: 100%;
                justify-content: center;
            }
        }

        select, button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 14px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        /* ---------- SIDEBAR ---------- */
        .sidebar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            height: 100%;
        }

        @media (max-width: 900px) {
            .sidebar {
                height: auto;
                max-height: 40vh;
            }
        }

        .coin-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
        }

        .coin-item:hover { background: #1c1c20; }
        .coin-item.selected { background: #1c1c20; border-left: 3px solid var(--accent); }

        .coin-header { display: flex; justify-content: space-between; }

        .main-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px;
            overflow-y: auto;
        }

        @media (max-width: 900px) {
            .main-panel {
                max-height: none;
            }
        }

        .setup-view { display: none; }
        .setup-view.active { display: block; }

        /* Entry/SL/TP Responsive Grid */
        .levels-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        @media (max-width: 700px) {
            .levels-grid {
                grid-template-columns: 1fr;
            }
        }

        .progress-line {
            position: absolute;
            bottom: 0; left: 0;
            height: 3px;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .hidden { display: none !important; }
    </style>
</head>

<body>

<div class="app-grid">

    <header>
        <div style="display:flex; align-items:center;">
            <h1>SMC Titan <span class="tag">PRO LOGIC</span></h1>
        </div>

        <div class="controls">
            <select id="tfInput">
                <option value="5m">5 Min (Scalp)</option>
                <option value="15m" selected>15 Min</option>
                <option value="1h">1 Hour</option>
                <option value="4h">4 Hour</option>
            </select>

            <button id="scanBtn" onclick="runScanner()">Start Scan</button>
        </div>
    </header>

    <div class="sidebar" id="resultsList">
        <div style="padding:20px; text-align:center; font-size:0.8rem; color:var(--text-secondary)">
            Waiting for scan...
            <br><br>
            <small>Strict Price Action Only. No Indicators.</small>
        </div>
    </div>

    <div class="main-panel" id="mainPanel">

        <div class="progress-line" id="progressBar"></div>

        <div id="emptyState" class="empty-state">
            <h2 style="color: var(--text-primary)">Ready to Scan</h2>
            <p>ICT 2022 Model:<br> Sweep → MSS → FVG Return</p>
        </div>

        <div id="setupView" class="setup-view">

            <h1 id="tickerDisplay" style="font-size: 2rem;">BTCUSDT</h1>

            <div class="data-row">
                <span>Current Price</span>
                <span id="priceDisplay">--</span>
            </div>

            <!-- ENTRY / SL / TP -->
            <div class="levels-grid">
                <div style="padding: 15px; background:#1c1c20; border-radius:6px;">
                    ENTRY<br>
                    <strong id="entryDisplay">--</strong>
                </div>
                <div style="padding: 15px; background:#1c1c20; border-radius:6px;">
                    STOP LOSS<br>
                    <strong id="slDisplay">--</strong>
                </div>
                <div style="padding: 15px; background:#1c1c20; border-radius:6px;">
                    TAKE PROFIT<br>
                    <strong id="tpDisplay">--</strong>
                </div>
            </div>

            <div id="logicSteps" style="margin-top:20px;"></div>

            <div class="chart-simulation">
                <strong>Algorithm Log:</strong><br>
                <span id="algoLog">Loading...</span>
            </div>

        </div>

    </div>

</div>

<script>
    const BINANCE_API = "https://api.binance.com/api/v3";
    let isScanning = false;

    /* ---------- SCANNER ---------- */
    async function runScanner() {
        if (isScanning) return;
        isScanning = true;

        const tf = document.getElementById("tfInput").value;
        const btn = document.getElementById("scanBtn");
        const list = document.getElementById("resultsList");
        const bar = document.getElementById("progressBar");

        btn.disabled = true;
        btn.innerText = "Scanning...";
        list.innerHTML = "";
        bar.style.width = "0%";

        const pairs = await getTopVolumePairs();
        let found = 0;

        for (let i = 0; i < pairs.length; i++) {
            const symbol = pairs[i];
            bar.style.width = `${((i + 1) / pairs.length) * 100}%`;
            await sleep(150);

            try {
                const candles = await getCandles(symbol, tf);
                if (candles.length < 50) continue;

                const setup = analyzeICT2022(symbol, candles);
                if (setup) {
                    found++;
                    addResultToList(setup);
                }
            } catch (err) {}
        }

        if (!found) {
            list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-secondary)">
                No strict setups found.
            </div>`;
        }

        isScanning = false;
        btn.disabled = false;
        btn.innerText = "Start Scan";

        setTimeout(() => bar.style.width = "0%", 800);
    }

    /* ---------- ICT LOGIC (unchanged) ---------- */
    function analyzeICT2022(symbol, candles) {
        const recent = candles.slice(-60);
        const swings = getFractals(recent);
        if (swings.lows.length < 2) return null;

        for (let i = recent.length - 5; i >= 10; i--) {
            let c = recent[i];

            for (let s = 0; s < swings.lows.length; s++) {
                let low = swings.lows[s];

                if (low.index < i - 3 && c.low < low.price) {
                    let interHigh = 0;
                    for (let k = low.index; k <= i; k++) {
                        interHigh = Math.max(interHigh, recent[k].high);
                    }

                    let mssIndex = -1;
                    for (let m = i + 1; m < recent.length; m++) {
                        if (recent[m].close > interHigh) {
                            mssIndex = m;
                            break;
                        }
                    }

                    if (mssIndex !== -1) {
                        let fvg = findFVG(recent, i, mssIndex);
                        if (fvg) {
                            let cur = recent[recent.length - 1].close;

                            if (cur <= fvg.top && cur >= fvg.bottom * 0.999) {
                                return {
                                    symbol,
                                    price: cur,
                                    sweepLevel: low.price,
                                    mssLevel: interHigh,
                                    fvg,
                                    stopLoss: c.low,
                                    takeProfit: interHigh * 1.02
                                };
                            }
                        }
                    }
                }
            }
        }

        return null;
    }

    function findFVG(c, start, end) {
        for (let i = start + 1; i < end; i++) {
            let p = c[i - 1];
            let n = c[i + 1];

            if (c[i].close > c[i].open && p.high < n.low) {
                return { top: n.low, bottom: p.high };
            }
        }
        return null;
    }

    function getFractals(c) {
        let lows = [];
        for (let i = 2; i < c.length - 2; i++) {
            if (
                c[i].low < c[i-1].low &&
                c[i].low < c[i-2].low &&
                c[i].low < c[i+1].low &&
                c[i].low < c[i+2].low
            ) {
                lows.push({ price: c[i].low, index: i });
            }
        }
        return { lows };
    }

    /* ---------- API ---------- */
    async function getTopVolumePairs() {
        try {
            let res = await fetch(`${BINANCE_API}/ticker/24hr`);
            let data = await res.json();
            return data
                .filter(d => d.symbol.endsWith("USDT"))
                .sort((a, b) => b.quoteVolume - a.quoteVolume)
                .slice(0, 50)
                .map(d => d.symbol);
        } catch {
            return [];
        }
    }

    async function getCandles(symbol, tf) {
        let url = `${BINANCE_API}/klines?symbol=${symbol}&interval=${tf}&limit=100`;
        let res = await fetch(url);
        let d = await res.json();
        return d.map(c => ({
            time: c[0],
            open: +c[1],
            high: +c[2],
            low: +c[3],
            close: +c[4]
        }));
    }

    /* ---------- UI ---------- */
    function addResultToList(setup) {
        const list = document.getElementById("resultsList");
        if (!list.innerHTML.includes("coin-item")) list.innerHTML = "";

        let el = document.createElement("div");
        el.className = "coin-item";
        el.innerHTML = `
            <div class="coin-header">
                <span>${setup.symbol}</span>
                <span class="coin-setup">ICT 2022</span>
            </div>
            <small>FVG ${setup.fvg.bottom.toFixed(4)} - ${setup.fvg.top.toFixed(4)}</small>
        `;
        el.onclick = () => renderSetup(setup, el);
        list.appendChild(el);
    }

    function renderSetup(setup, el) {
        document.querySelectorAll(".coin-item").forEach(i => i.classList.remove("selected"));
        el.classList.add("selected");

        document.getElementById("emptyState").classList.add("hidden");
        document.getElementById("setupView").classList.add("active");

        document.getElementById("tickerDisplay").innerText = setup.symbol;
        document.getElementById("priceDisplay").innerText = setup.price;
        document.getElementById("entryDisplay").innerText = setup.fvg.top;
        document.getElementById("slDisplay").innerText = setup.stopLoss;
        document.getElementById("tpDisplay").innerText = setup.takeProfit;

        document.getElementById("logicSteps").innerHTML = `
            ✔ Sweep at ${setup.sweepLevel}<br>
            ✔ MSS above ${setup.mssLevel}<br>
            ✔ FVG detected<br>
            ✔ Price returned into FVG
        `;
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
</script>

</body>
</html>
