<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Long Position Analysis</title>
    <style>
        /* Add styles for button, chart, and layout */
    </style>
</head>
<body>

    <div class="container">
        <h1>Live Crypto Long Position Analysis</h1>
        <p>Select a cryptocurrency:</p>

        <select id="cryptoDropdown">
            <option value="arbitrum">ARB</option>
            <option value="algorand">ALGO</option>
            <option value="fantom">FTM</option>
            <option value="sei">SEI</option>
            <option value="aptos">APT</option>
            <option value="masa-finance">MASA</option>
        </select>

        <p>Select a timeframe:</p>
        <select id="timeframeDropdown">
            <option value="1">1 Hour</option>
            <option value="4">4 Hours</option>
            <option value="12">12 Hours</option>
            <option value="24">1 Day</option>
            <option value="720">1 Month</option>
        </select>

        <button onclick="generateAnalysis()">Generate Analysis</button>

        <div class="loading" id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
            <p>Loading data, please wait...</p>
        </div>

        <div id="analysisResult" class="output" style="display: none;"></div>

        <!-- Reveal Rules Button -->
        <div id="rulesButton">Reveal Rules</div>

        <!-- Rules Output -->
        <div id="rulesOutput">
            <ul>
                <li><strong>RSI below 70</strong>: Indicates that the asset is not overbought, ideal for a long position.</li>
                <li><strong>MACD above 0</strong>: Shows that the trend is in an uptrend, further confirming the buy signal.</li>
                <li><strong>Price above 20 EMA</strong>: Indicates that the price is currently in an uptrend, following the short-term trend.</li>
                <li><strong>Price above support level</strong>: Signals that the price is trading above a key support level, a good indicator for bullish sentiment.</li>
                <li><strong>Resistance level</strong>: Price should be approaching or near resistance for a potential breakout above it.</li>
            </ul>
        </div>
    </div>

    <script>
        async function fetchCandleData(crypto, interval, days) {
            const url = `https://api.coingecko.com/api/v3/coins/${crypto}/market_chart?vs_currency=usd&days=${days}&interval=${interval}`;
            console.log("Fetching candle data from:", url); // Debug log for the URL
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (!data || !data.prices || !Array.isArray(data.prices)) {
                    throw new Error("Invalid data format received.");
                }
                return data;
            } catch (error) {
                console.error("Error fetching data:", error);
                return null;
            }
        }

        function calculateSupportResistance(candles) {
            let support = Math.min(...candles.map(candle => candle[1])); // Low
            let resistance = Math.max(...candles.map(candle => candle[2])); // High
            return { support, resistance };
        }

        function calculateEMA(candles, period = 20) {
            const closes = candles.map(candle => candle[4]); // Closing prices
            let ema = [];
            let k = 2 / (period + 1);
            ema.push(closes[0]); // First EMA is just the first close price
            for (let i = 1; i < closes.length; i++) {
                ema.push((closes[i] - ema[i - 1]) * k + ema[i - 1]);
            }
            return ema[ema.length - 1]; // Latest EMA
        }

        function calculateRSI(candles, period = 14) {
            const closes = candles.map(candle => candle[4]); // Closing prices
            let gains = 0, losses = 0;
            for (let i = 1; i <= period; i++) {
                const change = closes[i] - closes[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }
            let avgGain = gains / period, avgLoss = losses / period;
            const rs = avgGain / avgLoss;
            return 100 - (100 / (1 + rs));
        }

        function calculateMACD(candles) {
            const closes = candles.map(candle => candle[4]); // Closing prices
            let ema12 = calculateEMA(candles, 12);
            let ema26 = calculateEMA(candles, 26);
            return ema12 - ema26; // MACD line
        }

        function displayAnalysis(ema20, rsi14, macd, supportRes, timeframe, buySignal) {
            let verdict = buySignal ? "Buy" : "Do Not Buy";
            const analysis = `
                <h3>Analysis for ${timeframe}-hour Timeframe</h3>
                <p><strong>RSI:</strong> ${rsi14.toFixed(2)}</p>
                <p><strong>EMA (20):</strong> ${ema20.toFixed(2)}</p>
                <p><strong>MACD:</strong> ${macd.toFixed(2)}</p>
                <p><strong>Support Level:</strong> ${supportRes.support.toFixed(3)}</p>
                <p><strong>Resistance Level:</strong> ${supportRes.resistance.toFixed(3)}</p>
                <p><strong>Verdict:</strong> ${verdict}</p>
            `;
            document.getElementById("analysisResult").innerHTML = analysis;
        }

        async function generateAnalysis() {
            const crypto = document.getElementById("cryptoDropdown").value;
            const timeframe = document.getElementById("timeframeDropdown").value;

            let days = 1; // Default for 1 hour
            let interval = 'minute';

            // Adjust days and interval based on selected timeframe
            if (timeframe === "1") {
                days = 1 / 24;
                interval = 'minute';
            } else if (timeframe === "4") {
                days = 4 / 24;
                interval = 'minute';
            } else if (timeframe === "12") {
                days = 12 / 24;
                interval = 'minute';
            } else if (timeframe === "24") {
                days = 1;
                interval = 'hour';
            } else if (timeframe === "720") {
                days = 30; // For 1 month
                interval = 'day';
            }

            // Show loading spinner
            document.getElementById("loadingSpinner").style.display = "block";
            document.getElementById("analysisResult").style.display = "none";

            const data = await fetchCandleData(crypto, interval, days);

            if (!data || !data.prices) {
                alert("Error fetching valid data. Please try again.");
                document.getElementById("loadingSpinner").style.display = "none";
                return;
            }

            const candles = data.prices;
            const supportRes = calculateSupportResistance(candles);
            const ema20 = calculateEMA(candles);
            const rsi14 = calculateRSI(candles);
            const macd = calculateMACD(candles);

            const buySignal = (rsi14 < 70) && (macd > 0) && (candles[candles.length - 1][4] > ema20) && (candles[candles.length - 1][4] > supportRes.support);

            displayAnalysis(ema20, rsi14, macd, supportRes, timeframe, buySignal);

            document.getElementById("loadingSpinner").style.display = "none";
            document.getElementById("analysisResult").style.display = "block";
        }

        document.getElementById("rulesButton").onclick = function() {
            const rulesOutput = document.getElementById("rulesOutput");
            rulesOutput.style.display = rulesOutput.style.display === "none" ? "block" : "none";
        };
    </script>

</body>
</html>
