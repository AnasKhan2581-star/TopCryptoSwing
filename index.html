<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT/SMC 2022 Model Scanner</title>
    <style>
        :root {
            --bg-main: #09090b;
            --bg-card: #131316;
            --text-primary: #e4e4e7;
            --text-secondary: #a1a1aa;
            --accent: #3b82f6; /* Blue for ICT/Professional look */
            --success: #10b981;
            --danger: #ef4444;
            --border: #27272a;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Consolas', monospace; /* Mono font for trading terminal feel */
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* Layout */
        .app-grid {
            display: grid;
            grid-template-columns: 320px 1fr;
            grid-template-rows: auto 1fr;
            gap: 20px;
            height: 100%;
        }

        /* Header */
        header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            padding-bottom: 15px;
        }

        h1 { margin: 0; font-size: 1.2rem; letter-spacing: -0.5px; color: var(--text-primary); }
        .tag { background: var(--accent); color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 3px; margin-left: 10px; }

        /* Controls */
        .controls { display: flex; gap: 10px; }
        
        select, button {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 8px 16px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        button:hover { border-color: var(--accent); color: var(--accent); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        button.active-scan { border-color: var(--success); color: var(--success); }

        /* Sidebar */
        .sidebar {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .coin-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.1s;
        }

        .coin-item:hover { background: #1c1c20; }
        .coin-item.selected { background: #1c1c20; border-left: 3px solid var(--accent); }

        .coin-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .coin-symbol { font-weight: 700; font-size: 0.95rem; }
        .coin-setup { font-size: 0.75rem; color: var(--success); border: 1px solid var(--success); padding: 2px 4px; border-radius: 3px; }

        /* Main Panel */
        .main-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }

        /* Setup Display */
        .setup-view { display: none; }
        .setup-view.active { display: block; }

        .chart-simulation {
            border: 1px dashed var(--border);
            padding: 20px;
            margin: 20px 0;
            background: #000;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            border-bottom: 1px solid #27272a;
            padding-bottom: 8px;
        }
        .data-label { color: var(--text-secondary); }
        .data-val { font-weight: bold; }

        .confluence-list {
            margin-top: 20px;
            background: rgba(16, 185, 129, 0.05);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .step-check { color: var(--success); margin-right: 8px; }

        /* Progress */
        .progress-line {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
            text-align: center;
        }

        /* Helper classes */
        .text-green { color: var(--success); }
        .text-red { color: var(--danger); }
        .hidden { display: none !important; }

    </style>
</head>
<body>

    <div class="app-grid">
        <header>
            <div style="display:flex; align-items:center;">
                <h1>SMC Titan <span class="tag">PRO LOGIC</span></h1>
            </div>
            <div class="controls">
                <select id="tfInput">
                    <option value="5m">5 Min (Scalp)</option>
                    <option value="15m" selected>15 Min (Day)</option>
                    <option value="1h">1 Hour (Swing)</option>
                    <option value="4h">4 Hour (Macro)</option>
                </select>
                <button id="scanBtn" onclick="runScanner()">Start Scan</button>
            </div>
        </header>

        <div class="sidebar" id="resultsList">
            <div style="padding:20px; text-align:center; font-size:0.8rem; color:var(--text-secondary)">
                Waiting for scan...<br>
                <br>
                <small>This scanner enforces strict Price Action only. No indicators.</small>
            </div>
        </div>

        <div class="main-panel" id="mainPanel">
            <div class="progress-line" id="progressBar"></div>
            
            <div id="emptyState" class="empty-state">
                <h2 style="color: var(--text-primary)">Ready to Scan</h2>
                <p style="max-width: 400px;">
                    We will look for the <strong>ICT 2022 Model</strong>:<br><br>
                    1. Sell-side Liquidity Sweep (Stop Hunt)<br>
                    2. Market Structure Shift (MSS) with Displacement<br>
                    3. Return to FVG
                </p>
            </div>

            <div id="setupView" class="setup-view">
                <h1 id="tickerDisplay" style="font-size: 2.5rem; margin-bottom: 5px;">BTCUSDT</h1>
                <div style="color: var(--text-secondary); margin-bottom: 30px;">STRATEGY: <span style="color: var(--accent)">Liquidity Sweep + MSS + FVG Return</span></div>

                <div class="data-row">
                    <span class="data-label">Current Price</span>
                    <span class="data-val" id="priceDisplay">--</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Setup Status</span>
                    <span class="data-val text-green">PRICE INSIDE FVG</span>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-top: 30px;">
                    <div style="background: #1c1c20; padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                        <span class="data-label" style="font-size: 0.75rem;">ENTRY (Limit)</span><br>
                        <span class="data-val text-green" style="font-size: 1.2rem;" id="entryDisplay">--</span>
                    </div>
                    <div style="background: #1c1c20; padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                        <span class="data-label" style="font-size: 0.75rem;">STOP LOSS (Below Sweep)</span><br>
                        <span class="data-val text-red" style="font-size: 1.2rem;" id="slDisplay">--</span>
                    </div>
                    <div style="background: #1c1c20; padding: 15px; border-radius: 6px; border: 1px solid var(--border);">
                        <span class="data-label" style="font-size: 0.75rem;">TAKE PROFIT (Recent High)</span><br>
                        <span class="data-val" style="font-size: 1.2rem;" id="tpDisplay">--</span>
                    </div>
                </div>

                <div class="confluence-list" id="logicSteps">
                    </div>

                <div class="chart-simulation">
                    <strong>Algorithm Log:</strong><br>
                    <span id="algoLog">Loading...</span>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- CONFIGURATION ---
    const PROXY = 'https://api.allorigins.win/raw?url=';
    const BINANCE_API = 'https://api.binance.com/api/v3';
    
    // We need specific strict logic, so we define the "Swing Lookback"
    const FRACTAL_LOOKBACK = 5; // Standard fractal (5 candles: 2 left, 1 mid, 2 right)

    // --- STATE ---
    let isScanning = false;
    let selectedCoin = null;

    // --- MAIN LOGIC ---

    async function runScanner() {
        if (isScanning) return;
        isScanning = true;
        
        const btn = document.getElementById('scanBtn');
        const list = document.getElementById('resultsList');
        const tf = document.getElementById('tfInput').value;
        const bar = document.getElementById('progressBar');

        btn.innerText = "Scanning...";
        btn.disabled = true;
        list.innerHTML = ''; // Clear previous results
        bar.style.width = '0%';

        // 1. Get Top Volume Coins
        updateLog("Fetching top 50 volume pairs...");
        const pairs = await getTopVolumePairs();
        
        if (pairs.length === 0) {
            list.innerHTML = '<div style="padding:20px; color:var(--danger)">API Error. Check console or use CORS plugin.</div>';
            resetUI();
            return;
        }

        // 2. Scan Loop
        let foundCount = 0;
        
        for (let i = 0; i < pairs.length; i++) {
            const symbol = pairs[i];
            // Update Progress
            const pct = ((i+1) / pairs.length) * 100;
            bar.style.width = `${pct}%`;
            
            // Rate Limit Protection
            await sleep(150); 

            try {
                const candles = await getCandles(symbol, tf);
                if (candles.length < 100) continue;

                // --- THE PRO LOGIC CORE ---
                const setup = analyzeICT2022(symbol, candles);

                if (setup) {
                    foundCount++;
                    addResultToList(setup);
                }
            } catch (e) {
                console.error("Error analyzing " + symbol, e);
            }
        }

        if (foundCount === 0) {
            list.innerHTML = `<div style="padding:20px; text-align:center; color:var(--text-secondary)">
                No <strong>strict</strong> 2022 Model setups found.<br>
                The criteria are very high (Sweep + MSS + FVG).<br>
                Try a different timeframe.
            </div>`;
        }

        resetUI();
    }

    function resetUI() {
        isScanning = false;
        const btn = document.getElementById('scanBtn');
        btn.innerText = "Start Scan";
        btn.disabled = false;
        setTimeout(() => { document.getElementById('progressBar').style.width = '0%'; }, 1000);
    }

    // --- ALGORITHM: ICT 2022 MODEL ---
    // 1. Find recent Swing Low (Liquidity)
    // 2. Check if price swept it (Wick below, Close above OR just dipped below)
    // 3. Check for MSS (Break of Structure upward) AFTER the sweep
    // 4. Identify FVG in the upward leg
    // 5. Current Price must be IN the FVG
    
    function analyzeICT2022(symbol, candles) {
        // Helper: Get recent Swing Points (Fractals)
        // We only look at the last 50 candles to keep it "fresh"
        const recentCandles = candles.slice(-60); 
        const swings = getFractals(recentCandles);
        const currentPrice = recentCandles[recentCandles.length - 1].close;
        
        if (swings.lows.length < 2) return null;

        // STEP 1: Find a Valid Liquidity Sweep
        // We look for the lowest point in the recent structure that was "taken out"
        let sweepFound = false;
        let sweepDetails = {};

        // Iterate backwards to find a moment where price took out a previous low
        // We look for a "V" shape recovery
        // Logic: Find a candle (SweepCandle) whose LOW is lower than a previous Swing Low, 
        // but Price has since broken structure UP.
        
        let potentialSetup = null;

        // Iterate through identified Swing Lows to see if they were swept
        // We look at the LAST 2 Swing Lows. 
        const lastKeyLow = swings.lows[swings.lows.length - 1]; // The most recent fractal low
        const prevKeyLow = swings.lows[swings.lows.length - 2]; // The one before

        // We need a scenario where:
        // 1. There was a defined low (prevKeyLow).
        // 2. Price went below it (Swept).
        // 3. Price rallied causing a MSS (Market Structure Shift).
        
        // Let's simplify: Find the lowest point in the last 20 candles. 
        // Was that lowest point a "Sweep" of an older low?
        
        // 1. Identify the "Liquidity Pool" (A distinct swing low from > 15 candles ago but < 60)
        let liquidityPoolIndex = -1;
        let liquidityPoolPrice = 99999999;

        // Let's search for the sweep event manually to be precise
        // We scan candles [10...end-2]
        for (let i = recentCandles.length - 5; i >= 10; i--) {
            let c = recentCandles[i]; // Potential Sweep Candle
            
            // Look back for a low that is HIGHER than c.low (meaning c swept it)
            // and that low must be a fractal.
            for (let s = 0; s < swings.lows.length; s++) {
                let sLow = swings.lows[s];
                
                // If this swing low is older than our current candle (index is smaller)
                if (sLow.index < i - 3) { // Must be at least 3 bars old to be "liquidity"
                    
                    // CHECK 1: DID WE SWEEP?
                    if (c.low < sLow.price) {
                        
                        // CHECK 2: DID WE DISPLACE UP? (MSS)
                        // Look from sweep candle forward. Did we break the high formed *between* the old low and the sweep?
                        // Find the high between sLow.index and i
                        let interHigh = 0;
                        for(let k = sLow.index; k <= i; k++) {
                            if (recentCandles[k].high > interHigh) interHigh = recentCandles[k].high;
                        }

                        // Check if current price, or recent price broke that High
                        // Also check if we have displacement (large green candles)
                        let mssIndex = -1;
                        for(let m = i + 1; m < recentCandles.length; m++) {
                            if (recentCandles[m].close > interHigh) {
                                mssIndex = m;
                                break;
                            }
                        }

                        if (mssIndex !== -1) {
                            // We have Sweep + MSS.
                            // CHECK 3: Is there an FVG in the Displacement leg?
                            // Displacement leg is from Sweep (i) to MSS (mssIndex)
                            
                            let fvg = findFVG(recentCandles, i, mssIndex);
                            
                            if (fvg) {
                                // CHECK 4: IS PRICE CURRENTLY IN THE FVG?
                                // or slightly above/below (Retracement phase)
                                
                                // Condition: Current price < FVG Top (it has returned)
                                // And Current price > FVG Bottom (it hasn't failed)
                                const cur = recentCandles[recentCandles.length-1].close;
                                
                                if (cur <= fvg.top && cur >= fvg.bottom * 0.999) {
                                    return {
                                        symbol: symbol,
                                        price: cur,
                                        sweepLevel: sLow.price,
                                        mssLevel: interHigh,
                                        fvg: fvg,
                                        stopLoss: c.low, // Stop below the sweep
                                        takeProfit: interHigh * 1.02 // Generic targeting old high + expansion
                                    };
                                }
                            }
                        }
                    }
                }
            }
        }

        return null;
    }

    // --- UTILS: FVG & Fractals ---

    function findFVG(candles, startIndex, endIndex) {
        // Look for Gap between (i-1 high) and (i+1 low) in a GREEN sequence
        for (let i = startIndex + 1; i < endIndex; i++) {
            let cPrev = candles[i-1];
            let cNext = candles[i+1];
            
            // Bullish FVG: Previous candle High < Next candle Low
            // And the middle candle (i) is Green
            if (candles[i].close > candles[i].open) {
                if (cPrev.high < cNext.low) {
                    // Found FVG
                    return {
                        top: cNext.low,
                        bottom: cPrev.high,
                        index: i
                    };
                }
            }
        }
        return null;
    }

    function getFractals(candles) {
        let highs = [];
        let lows = [];
        // 5 Bar Fractal: 2 Left, Center, 2 Right
        for (let i = 2; i < candles.length - 2; i++) {
            const c = candles[i];
            // Low Fractal
            if (c.low < candles[i-1].low && c.low < candles[i-2].low &&
                c.low < candles[i+1].low && c.low < candles[i+2].low) {
                lows.push({ price: c.low, index: i });
            }
            // High Fractal
            if (c.high > candles[i-1].high && c.high > candles[i-2].high &&
                c.high > candles[i+1].high && c.high > candles[i+2].high) {
                highs.push({ price: c.high, index: i });
            }
        }
        return { highs, lows };
    }

    // --- DATA FETCHING ---

    async function getTopVolumePairs() {
        try {
            const res = await fetch(`${PROXY}${encodeURIComponent(`${BINANCE_API}/ticker/24hr`)}`);
            const data = await res.json();
            return data
                .filter(d => d.symbol.endsWith('USDT') && parseFloat(d.quoteVolume) > 10000000)
                .sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume))
                .slice(0, 50)
                .map(d => d.symbol);
        } catch (e) { return []; }
    }

    async function getCandles(symbol, interval) {
        try {
            const url = `${BINANCE_API}/klines?symbol=${symbol}&interval=${interval}&limit=100`;
            const res = await fetch(`${PROXY}${encodeURIComponent(url)}`);
            const data = await res.json();
            return data.map(d => ({
                time: d[0],
                open: parseFloat(d[1]),
                high: parseFloat(d[2]),
                low: parseFloat(d[3]),
                close: parseFloat(d[4])
            }));
        } catch (e) { return []; }
    }

    // --- UI HANDLERS ---

    function addResultToList(setup) {
        const list = document.getElementById('resultsList');
        // Remove waiting message if exists
        if (list.innerText.includes('Waiting')) list.innerHTML = '';

        const el = document.createElement('div');
        el.className = 'coin-item';
        el.innerHTML = `
            <div class="coin-header">
                <span class="coin-symbol">${setup.symbol}</span>
                <span class="coin-setup">ICT 2022</span>
            </div>
            <div style="font-size:0.75rem; color:var(--text-secondary)">
                FVG: ${setup.fvg.bottom.toFixed(4)} - ${setup.fvg.top.toFixed(4)}
            </div>
        `;
        el.onclick = () => renderSetup(setup, el);
        list.appendChild(el);
    }

    function renderSetup(setup, el) {
        // Highlight
        document.querySelectorAll('.coin-item').forEach(i => i.classList.remove('selected'));
        el.classList.add('selected');

        // Show View
        document.getElementById('emptyState').classList.add('hidden');
        const view = document.getElementById('setupView');
        view.classList.add('active');

        // Populate
        document.getElementById('tickerDisplay').innerText = setup.symbol;
        document.getElementById('priceDisplay').innerText = setup.price.toFixed(4);
        document.getElementById('entryDisplay').innerText = setup.fvg.top.toFixed(4);
        document.getElementById('slDisplay').innerText = setup.stopLoss.toFixed(4);
        document.getElementById('tpDisplay').innerText = setup.takeProfit.toFixed(4);

        // Logic Logs
        const log = document.getElementById('logicSteps');
        log.innerHTML = `
            <div><span class="step-check">✔</span> <strong>Liquidity Sweep:</strong> Price swept Swing Low at ${setup.sweepLevel}</div>
            <div style="margin-top:5px"><span class="step-check">✔</span> <strong>Displacement:</strong> Aggressive break of structure (MSS) above ${setup.mssLevel}</div>
            <div style="margin-top:5px"><span class="step-check">✔</span> <strong>FVG Creation:</strong> Bullish imbalance left at ${setup.fvg.bottom}</div>
            <div style="margin-top:5px"><span class="step-check">✔</span> <strong>Return to Origin:</strong> Price has retraced into the FVG.</div>
        `;

        document.getElementById('algoLog').innerHTML = `
            SCANNER ID: SMC-V2<br>
            DETECTED SWEEP CANDLE INDEX: ${setup.stopLoss} (approx)<br>
            FVG VALIDATED. ORDER FLOW BULLISH.
        `;
    }

    function updateLog(msg) {
        // Optional: could add a status bar text
        console.log(msg);
    }
    
    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

</script>
</body>
</html>
