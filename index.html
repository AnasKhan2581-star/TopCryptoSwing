<script>
    async function fetchCandleData(crypto, interval, days) {
        const url = `https://api.coingecko.com/api/v3/coins/${crypto}/market_chart?vs_currency=usd&days=${days}&interval=${interval}`;
        console.log("Fetching candle data from:", url); // Log the URL for debugging
        
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            // Log the response data to inspect it
            console.log("Fetched data:", data);
            
            if (!data || !data.prices || !Array.isArray(data.prices)) {
                throw new Error("Invalid data format received. Please check the API response.");
            }
            return data;
        } catch (error) {
            console.error("Error fetching data:", error);
            alert("Error fetching data: " + error.message);
            return null;
        }
    }

    async function generateAnalysis() {
        const crypto = document.getElementById("cryptoDropdown").value;
        const timeframe = document.getElementById("timeframeDropdown").value;

        let days = 1; // Default for 1 hour
        let interval = 'minute';

        // Adjust days and interval based on selected timeframe
        if (timeframe === "1") {
            days = 1 / 24;
            interval = 'minute';
        } else if (timeframe === "4") {
            days = 4 / 24;
            interval = 'minute';
        } else if (timeframe === "12") {
            days = 12 / 24;
            interval = 'minute';
        } else if (timeframe === "24") {
            days = 1;
            interval = 'hour';
        } else if (timeframe === "720") {
            days = 30; // For 1 month
            interval = 'day';
        }

        // Show loading spinner
        document.getElementById("loadingSpinner").style.display = "block";
        document.getElementById("analysisResult").style.display = "none";

        const data = await fetchCandleData(crypto, interval, days);

        if (!data || !data.prices) {
            alert("Error fetching valid data. Please try again.");
            document.getElementById("loadingSpinner").style.display = "none";
            return;
        }

        const candles = data.prices;
        const supportRes = calculateSupportResistance(candles);
        const ema20 = calculateEMA(candles);
        const rsi14 = calculateRSI(candles);
        const macd = calculateMACD(candles);

        const buySignal = (rsi14 < 70) && (macd > 0) && (candles[candles.length - 1][4] > ema20) && (candles[candles.length - 1][4] > supportRes.support);

        displayAnalysis(ema20, rsi14, macd, supportRes, timeframe, buySignal);

        document.getElementById("loadingSpinner").style.display = "none";
        document.getElementById("analysisResult").style.display = "block";
    }
</script>
