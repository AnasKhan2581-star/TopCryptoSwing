<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Liquidity Trap Scanner v3.0 — Bullish Institutional Engine</title>

<style>
:root {
  --bg-main:#050509;
  --bg-card:#111118;
  --bg-panel:#181820;
  --border:#262636;
  --accent:#3b82f6;
  --accent-soft:#60a5fa;
  --text:#e5e7eb;
  --text-soft:#9ca3af;
  --green:#10b981;
  --red:#ef4444;
  --radius:10px;
}

*{box-sizing:border-box;}

body{
  margin:0;
  padding:0;
  background:var(--bg-main);
  color:var(--text);
  font-family:"JetBrains Mono",monospace;
  min-height:100vh;      /* was: height:100vh */
  overflow:auto;
}

.app-grid{
  display:grid;
  grid-template-columns:280px 1fr 360px;
  grid-template-rows:minmax(0, 1fr);
}

@media (max-width:1000px){
  .app-grid{
    grid-template-columns:1fr;
    grid-template-rows:auto auto auto;
    height:auto;
  }
}

.sidebar{
  background:var(--bg-card);
  border-right:1px solid var(--border);
  padding:18px;
  overflow-y:auto;
}

.sidebar h2{
  margin:0 0 12px 0;
  font-size:1.05rem;
}

.main-panel{
  background:var(--bg-main);
  padding:22px;
  position:relative;
  overflow-y:auto;
}

.drawer{
  background:var(--bg-card);
  border-left:1px solid var(--border);
  padding:18px;
  overflow-y:auto;
}

@media (max-width:1000px){
  .drawer{
    border-left:none;
    border-top:1px solid var(--border);
  }
}

.tf-select, .scan-btn{
  padding:8px 14px;
  border-radius:6px;
  border:1px solid var(--border);
  background:var(--bg-panel);
  color:var(--text);
  font-family:inherit;
  font-size:0.9rem;
  cursor:pointer;
}

.scan-btn:hover{
  border-color:var(--accent);
  color:var(--accent-soft);
}

.filter-title{
  font-size:0.8rem;
  color:var(--text-soft);
  margin-bottom:4px;
}

.coin-list{
  margin-top:10px;
}

.coin-item{
  padding:10px 12px;
  margin-bottom:8px;
  background:var(--bg-panel);
  border-radius:8px;
  border:1px solid var(--border);
  cursor:pointer;
  transition:0.15s;
}

.coin-item:hover{
  border-color:var(--accent);
}

.coin-item.active{
  background:#1d1d27;
  border-left:4px solid var(--accent);
}

.coin-symbol{
  font-size:0.92rem;
}

.tag-mini{
  display:inline-block;
  font-size:0.7rem;
  padding:1px 5px;
  border-radius:4px;
  border:1px solid var(--accent);
  color:var(--accent-soft);
  margin-top:4px;
}

.header-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}

@media (max-width:600px){
  .header-top{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
}

.status-text{
  font-size:0.8rem;
  color:var(--text-soft);
  margin-bottom:12px;
}

.visual-box{
  background:var(--bg-panel);
  border-radius:var(--radius);
  border:1px solid var(--border);
  padding:16px;
  min-height:180px;
  font-size:0.85rem;
  color:var(--text-soft);
}

/* Spinner + Progress */
.spinner-overlay{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:50;
}

.spinner{
  width:52px;
  height:52px;
  border-radius:50%;
  border:5px solid var(--bg-panel);
  border-top-color:var(--accent);
  animation:spin .7s linear infinite;
}

@keyframes spin{
  to{transform:rotate(360deg);}
}

.hidden{display:none !important;}

.progress-line{
  position:absolute;
  left:0;
  bottom:0;
  height:3px;
  background:var(--accent);
  width:0%;
  transition:width 0.2s;
}

/* Drawer info */
.drawer h2{
  margin-top:0;
  font-size:1.05rem;
}

.info-block{
  background:var(--bg-panel);
  border-radius:var(--radius);
  border:1px solid var(--border);
  padding:12px 14px;
  margin-bottom:12px;
  font-size:0.83rem;
}

.level-row{
  display:flex;
  justify-content:space-between;
  margin-bottom:4px;
}

#logicLog{
  white-space:pre-line;
}
</style>
</head>
<body>

<div class="app-grid">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>Liquidity Trap Scanner</h2>

    <div style="margin-bottom:18px;">
      <div class="filter-title">Timeframe</div>
      <select id="tfInput" class="tf-select">
        <option value="5m">5m</option>
        <option value="15m" selected>15m</option>
        <option value="1h">1h</option>
        <option value="4h">4h</option>
      </select>
    </div>

    <div class="filter-title">Model</div>
    <div style="font-size:0.75rem;color:var(--text-soft);margin-bottom:18px;">
      • Only Bullish Liquidity Trap Setups<br/>
      • Fake breakdown of support / bearish patterns<br/>
      • Strict filters (high quality only)
    </div>

    <h2>Coins</h2>
    <div id="resultsList" class="coin-list">
      <div style="padding:10px;color:var(--text-soft);text-align:center;">
        Waiting for scan...
      </div>
    </div>
  </div>

  <!-- MAIN PANEL -->
  <div class="main-panel" id="mainPanel">

    <div id="spinner" class="spinner-overlay hidden">
      <div class="spinner"></div>
    </div>

    <div class="header-top">
      <div>
        <div style="font-size:1.05rem;">Institutional Bullish Trap Engine v3.0</div>
        <div style="font-size:0.75rem;color:var(--text-soft);">
          Sell-side liquidity sweep → Displacement + FVG → BOS → Return to FVG
        </div>
      </div>
      <button id="scanBtn" class="scan-btn" onclick="runScanner()">Scan Now</button>
    </div>

    <div id="scanStatus" class="status-text">
      Ready to scan.
    </div>

    <div id="visualArea" class="visual-box">
      Select a coin from the left list after scanning to view its trap structure explanation.
    </div>

    <div id="progressBar" class="progress-line"></div>
  </div>

  <!-- RIGHT DRAWER -->
  <div class="drawer">
    <h2 id="drawerTitle">Details</h2>

    <div class="info-block">
      <div class="level-row"><span>Entry (FVG mid):</span> <span id="entryDisplay">--</span></div>
      <div class="level-row"><span>Stop Loss:</span> <span id="slDisplay">--</span></div>
      <div class="level-row"><span>TP1 (1:2):</span> <span id="tp1Display">--</span></div>
      <div class="level-row"><span>TP2 (1:3):</span> <span id="tp2Display">--</span></div>
      <div class="level-row"><span>TP Structural:</span> <span id="tp3Display">--</span></div>
    </div>

    <div id="logicLog" class="info-block">
      Select a coin to see full institution-style breakdown.
    </div>
  </div>

</div>

<script>
// ================== BINANCE API HELPERS ===================
const API = "https://api.binance.com/api/v3";
const sleep = (ms) => new Promise(r=>setTimeout(r,ms));

async function getCandles(symbol, interval){
  try{
    const r = await fetch(`${API}/klines?symbol=${symbol}&interval=${interval}&limit=300`);
    const j = await r.json();
    return j.map(k=>({
      time:k[0],
      open:+k[1],
      high:+k[2],
      low:+k[3],
      close:+k[4]
    }));
  }catch(e){
    console.error("Candle error",symbol,e);
    return [];
  }
}

async function getTopVolumePairs(){
  try{
    const r = await fetch(`${API}/ticker/24hr`);
    const j = await r.json();
    return j
      .filter(x=>x.symbol.endsWith("USDT"))
      .sort((a,b)=> (+b.quoteVolume) - (+a.quoteVolume))
      .slice(0,50)
      .map(x=>x.symbol);
  }catch(e){
    console.error("Top vol error",e);
    return [];
  }
}

// =============== CONTEXT: BEARISH LEG CHECK =================
function isBearishContext(candles, endIndex){
  const lookback = 40;
  const start = Math.max(0, endIndex - lookback);
  let downCount = 0;
  let prevClose = candles[start].close;
  let highTrendDown = 0;
  for(let i=start+1;i<=endIndex;i++){
    const cc = candles[i];
    if(cc.close < prevClose) downCount++;
    if(cc.high < candles[i-1].high) highTrendDown++;
    prevClose = cc.close;
  }
  const len = endIndex - start;
  if(len < 15) return false;
  return (downCount/len > 0.55) && (highTrendDown/len > 0.5);
}

// =============== SUPPORT ZONE DETECTION =====================
function findSupportZone(candles, upToIndex){
  const lows = [];
  for(let i = upToIndex-40; i<upToIndex; i++){
    if(i<2) continue;
    const c = candles[i];
    if(c.low < candles[i-1].low && c.low < candles[i-2].low){
      lows.push({index:i, price:c.low});
    }
  }
  if(lows.length < 2) return null;
  lows.sort((a,b)=> a.price - b.price);
  const base = lows[0].price;
  const zoneHigh = base * 1.002; // tiny band above
  const touches = lows.filter(l => l.price <= zoneHigh);
  if(touches.length < 2) return null;
  return {
    level:(base + zoneHigh)/2,
    touches
  };
}

// =============== STRONG LOW (SWEEP OF SUPPORT) ==============
function detectStrongLow(candles, i, support){
  const c = candles[i];
  const body = Math.abs(c.close - c.open);
  const lowerWick = c.open - c.low;
  if(lowerWick < body * 2.5) return null;
  if(!support) return null;
  if(c.low >= support.level) return null;
  return {
    index:i,
    price:c.low,
    wickToBody: lowerWick / (body || 0.0001),
    supportLevel: support.level,
    supportTouches: support.touches
  };
}

// =============== DISPLACEMENT + FVG =========================
function detectDisplacementAndFVG(candles, startIndex){
  for(let i=startIndex; i<startIndex+8 && i<candles.length-2; i++){
    const mid = candles[i];
    const prev = candles[i-1];
    const next = candles[i+1];

    const bull = mid.close > mid.open;
    const gap = prev.high < next.low;
    const bodySize = Math.abs(mid.close - mid.open);
    const prevRange = prev.high - prev.low;
    const nextRange = next.high - next.low;
    const impulse = bodySize > (prevRange*0.7) && bodySize > (nextRange*0.7);

    if(bull && gap && impulse){
      return {
        index:i,
        fvgBottom: prev.high,
        fvgTop: next.low,
        impulseAggression: bodySize / ((mid.high-mid.low) || 0.0001)
      };
    }
  }
  return null;
}

// =============== SWING HIGH BEFORE SWEEP ====================
function findPreSweepSwingHigh(candles, strongIndex){
  let highest = -Infinity;
  let highestIdx = -1;
  for(let i=strongIndex-10; i<strongIndex; i++){
    if(i<2) continue;
    const c = candles[i];
    if(c.high > candles[i-1].high && c.high > candles[i-2].high){
      if(c.high > highest){
        highest = c.high;
        highestIdx = i;
      }
    }
  }
  if(highestIdx === -1) return null;
  return { index:highestIdx, price:highest };
}

// =============== BOS CONFIRMATION ===========================
function confirmBOS(candles, swingHigh){
  if(!swingHigh) return null;
  for(let i=swingHigh.index+1; i<candles.length; i++){
    if(candles[i].high > swingHigh.price){
      let ext = candles[i].high;
      for(let j=i+1; j<candles.length; j++){
        if(candles[j].high > ext) ext = candles[j].high;
      }
      return { internal: swingHigh.price, external: ext };
    }
  }
  return null;
}

// =============== FVG RETURN (ENTRY CONDITION) ===============
function inFVGNow(candles, fvg){
  const last = candles[candles.length-1];
  const price = last.close;
  if(price < fvg.fvgBottom*0.995) return false;
  if(price > fvg.fvgTop) return false;
  return true;
}

// =============== TARGETS CALC ===============================
function computeTargets(entry, sl, bos){
  const risk = entry - sl;
  return {
    rr2: entry + risk*2,
    rr3: entry + risk*3,
    structure: bos ? bos.external*1.01 : entry + risk*4
  };
}

// =============== MASTER TRAP DETECTOR =======================
function detectBullishTrap(symbol, candles){
  if(candles.length < 100) return null;
  const c = candles.slice(-120);
  for(let i=25; i<c.length-20; i++){
    if(!isBearishContext(c, i)) continue;
    const support = findSupportZone(c, i);
    const strongLow = detectStrongLow(c, i, support);
    if(!strongLow) continue;

    const displacement = detectDisplacementAndFVG(c, i+1);
    if(!displacement) continue;

    const swingHigh = findPreSweepSwingHigh(c, i);
    const bos = confirmBOS(c, swingHigh);
    if(!bos) continue;

    if(!inFVGNow(c, displacement)) continue;

    const entry = (displacement.fvgTop + displacement.fvgBottom)/2;
    const sl = strongLow.price;
    const targets = computeTargets(entry, sl, bos);

    return {
      symbol,
      entry,
      sl,
      targets,
      strongLow,
      displacement,
      bos,
      support,
      contextBearish:true
    };
  }
  return null;
}

// =============== UI LOGIC ===================================
function renderList(results){
  const list = document.getElementById("resultsList");
  list.innerHTML = "";
  results.forEach(res=>{
    const el = document.createElement("div");
    el.className = "coin-item";
    el.innerHTML = `
      <div class="coin-symbol">${res.symbol}</div>
      <div><span class="tag-mini">Bullish Trap</span></div>
    `;
    el.onclick = ()=> showDetails(res, el);
    list.appendChild(el);
  });
}

function showDetails(res, el){
  document.querySelectorAll(".coin-item").forEach(x=>x.classList.remove("active"));
  el.classList.add("active");

  document.getElementById("drawerTitle").innerText = res.symbol;
  document.getElementById("entryDisplay").innerText = res.entry.toFixed(4);
  document.getElementById("slDisplay").innerText = res.sl.toFixed(4);
  document.getElementById("tp1Display").innerText = res.targets.rr2.toFixed(4);
  document.getElementById("tp2Display").innerText = res.targets.rr3.toFixed(4);
  document.getElementById("tp3Display").innerText = res.targets.structure.toFixed(4);

  const s = res.strongLow;
  const d = res.displacement;
  const b = res.bos;
  const sup = res.support;

  const explanation =
`BULLISH LIQUIDITY TRAP (STRICT)\n
1. BEARISH CONTEXT
   • Price in a local downtrend before trap (lower highs / lower closes).
   • Simulates common retail bearish patterns (flags, triangles, channels).
\n2. SUPPORT ZONE & STRONG LOW SWEEP
   • Support zone from at least 2 swing lows ≈ ${sup ? sup.level.toFixed(4) : "n/a"}.
   • Strong Low candle wicked through support:
       - Strong Low: ${s.price.toFixed(4)}
       - Wick/Body aggression: ${s.wickToBody.toFixed(2)}x
   • This represents the fake breakdown / stop-hunt under support.
\n3. BULLISH DISPLACEMENT + FVG
   • In the next few candles, a strong bullish displacement formed an FVG:
       - FVG Bottom: ${d.fvgBottom.toFixed(4)}
       - FVG Top:    ${d.fvgTop.toFixed(4)}
       - Impulse aggression: ${d.impulseAggression.toFixed(2)}
   • This is smart money driving price away from the trap low.
\n4. BREAK OF STRUCTURE (BOS)
   • Structure high before sweep was broken:
       - Internal BOS level: ${b.internal.toFixed(4)}
       - External extension: ${b.external.toFixed(4)}
   • Confirms market regime shift after raid.
\n5. RETURN TO FVG (ENTRY)
   • Current price has returned into the FVG zone.
   • We use the FVG midpoint as entry for balanced RR:
       - Entry (mid): ${res.entry.toFixed(4)}
       - SL below strong low: ${res.sl.toFixed(4)}
\n6. TARGETS (RR-BASED)
   • TP1 (1:2 RR): ${res.targets.rr2.toFixed(4)}
   • TP2 (1:3 RR): ${res.targets.rr3.toFixed(4)}
   • TP Structural: ${res.targets.structure.toFixed(4)}
\nThis is a full fake breakdown → displacement → BOS → return-to-imbalance trap model.
`;

  document.getElementById("logicLog").innerText = explanation;
  document.getElementById("visualArea").innerText =
    `Selected: ${res.symbol}\n\n` +
    `Strong Low at ${s.price.toFixed(4)} swept prior support ~${sup ? sup.level.toFixed(4) : "n/a"}\n` +
    `FVG: ${d.fvgBottom.toFixed(4)} → ${d.fvgTop.toFixed(4)}\n` +
    `BOS above ${b.internal.toFixed(4)}, extension up to ${b.external.toFixed(4)}\n\n` +
    `Price is now inside FVG → watching for reaction from entry zone.`;
}

// =============== SCANNER ====================================
let scanning = false;

async function runScanner(){
  if(scanning) return;
  scanning = true;

  const tf = document.getElementById("tfInput").value;
  const spinner = document.getElementById("spinner");
  const status = document.getElementById("scanStatus");
  const bar = document.getElementById("progressBar");
  const list = document.getElementById("resultsList");

  spinner.classList.remove("hidden");
  status.innerText = "Fetching top-volume pairs...";
  list.innerHTML = `<div style="padding:10px;color:var(--text-soft);text-align:center;">Scanning...</div>`;

  const pairs = await getTopVolumePairs();
  if(!pairs.length){
    spinner.classList.add("hidden");
    status.innerText = "Error: could not fetch Binance ticker data.";
    scanning = false;
    return;
  }

  const results = [];
  status.innerText = `Scanning ${pairs.length} pairs on ${tf}...`;

  for(let i=0;i<pairs.length;i++){
    const sym = pairs[i];
    bar.style.width = ((i+1)/pairs.length)*100 + "%";

    const candles = await getCandles(sym, tf);
    if(candles.length){
      const trap = detectBullishTrap(sym, candles);
      if(trap) results.push(trap);
    }

    await sleep(120); // small delay to avoid hammering Binance
  }

  spinner.classList.add("hidden");
  bar.style.width = "0%";
  scanning = false;

  status.innerText = `Scan complete: ${results.length} bullish trap setups found.`;

  if(!results.length){
    list.innerHTML = `<div style="padding:10px;color:var(--text-soft);text-align:center;">No strict-quality traps found. Try another timeframe.</div>`;
  }else{
    renderList(results);
  }
}
</script>

</body>
</html>
